name: TKG Backend Deploy

on:
  push:
    branches:
      - master  # 确保这里和你本地 git branch 查出来的名字一致

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取最新的代码
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. 安装 JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. Maven 打包
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 4. 把打好的 Jar 包传送到服务器
      - name: Upload Jar to Server
        uses: appleboy/scp-action@master
        with:
          host: 8.148.25.67
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "target/*.jar"
          target: "/opt/tkg/backend/temp"
          strip_components: 1

      # 5. SSH 远程执行：停止旧程序，启动新程序
      - name: Deploy and Start
        uses: appleboy/ssh-action@master
        with:
          host: 8.148.25.67
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. 环境准备
            mkdir -p /opt/tkg/backend/temp
            mkdir -p /opt/tkg/logs
            cd /opt/tkg/backend
            
            # 2. 如果 temp 文件夹里有新包，则覆盖旧包
            if ls temp/*.jar 1> /dev/null 2>&1; then
                echo "New JAR detected. Moving to target..."
                mv -f temp/*.jar tkg-api.jar
            fi
            
            # 3. 杀掉 8080 端口的旧进程
            PID=$(lsof -t -i:8080) || true
            if [ ! -z "$PID" ]; then
              echo "Stopping existing process: $PID"
              kill -9 $PID
              sleep 2
            fi
            
            # 4. 启动新程序
            # 显式挂载外部 application-prod.yml 配置文件
            echo "Starting application..."
            nohup java -Xmx512m -Xms256m -jar tkg-api.jar \
              --spring.config.location=/opt/tkg/backend/application-prod.yml \
              > /opt/tkg/logs/app.log 2>&1 &
            
            # 5. 打印状态检查
            echo "Deployment sequence finished."
            sleep 3
            ps -ef | grep tkg-api.jar | grep -v grep || true